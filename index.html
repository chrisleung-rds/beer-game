<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å™´ç™¼å•¤é…’æŒ‘æˆ°è³½ - MINI GAME</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            touch-action: none;
            overflow: hidden;
            background: #0f172a;
            color: white;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }

        /* ç“¶å­éœ‡å‹•å‹•ç•« */
        .bottle-container {
            position: relative;
            height: 320px;
            transition: transform 0.1s;
        }

        .shaking {
            animation: shake 0.1s infinite;
        }

        @keyframes shake {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            20% { transform: translate(-3px, 0px) rotate(-1.5deg); }
            40% { transform: translate(3px, 2px) rotate(1.5deg); }
            60% { transform: translate(-1px, -1px) rotate(1deg); }
            80% { transform: translate(-3px, 1px) rotate(-1deg); }
            100% { transform: translate(1px, -2px) rotate(-1.5deg); }
        }

        /* å™´ç™¼æ³¡æ²«ç‰¹æ•ˆ */
        .foam-spray {
            position: absolute;
            bottom: 240px;
            left: 50%;
            transform: translateX(-50%);
            width: 50px;
            background: linear-gradient(to top, #ffffff, rgba(255,255,255,0));
            border-radius: 30px 30px 0 0;
            height: 0;
            transition: height 0.6s cubic-bezier(0.17, 0.89, 0.32, 1.49);
            z-index: 10;
            filter: blur(4px);
        }

        .particle {
            position: absolute;
            background: white;
            border-radius: 50%;
            pointer-events: none;
            z-index: 20;
        }

        .hidden-screen {
            display: none !important;
        }

        /* é€²åº¦æ¢ç™¼å…‰ */
        .progress-glow {
            box-shadow: 0 0 20px rgba(245, 158, 11, 0.7);
        }

        /* æŒ‡ç¤ºç‡ˆ */
        #sensor-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #ef4444;
            display: inline-block;
            transition: background 0.2s;
        }
        .sensor-ok { background: #22c55e !important; }
    </style>
</head>
<body class="flex flex-col items-center justify-between h-screen p-8 bg-gradient-to-b from-slate-900 to-black">

    <!-- 1. é–‹å§‹ç•«é¢ -->
    <div id="start-screen" class="flex flex-col items-center justify-center flex-grow space-y-10 text-center">
        <div class="space-y-2">
            <h1 class="text-5xl font-black text-amber-500 tracking-tighter">BEER POP!</h1>
            <p class="text-slate-400 text-lg">ç˜‹ç‹‚æ–å‹•æ‰‹æ©Ÿç´¯ç©å£“åŠ›</p>
        </div>
        
        <div class="w-56 h-56 bg-slate-800/50 rounded-full flex items-center justify-center border-4 border-amber-500/30 relative">
             <span class="text-8xl animate-bounce">ğŸ“±</span>
             <div class="absolute -bottom-2 bg-amber-500 text-black text-xs font-bold px-3 py-1 rounded-full uppercase">Shake Me</div>
        </div>

        <div id="https-msg" class="hidden-screen text-amber-200 bg-amber-900/30 p-4 rounded-xl text-sm border border-amber-500/20 max-w-xs">
            æ³¨æ„ï¼šè‹¥ç„¡æ³•åµæ¸¬æ–å‹•ï¼Œè«‹ç¢ºä¿ç¶²å€ç‚º <strong>HTTPS</strong> æ ¼å¼ã€‚
        </div>

        <button id="btn-start" class="bg-amber-500 hover:bg-amber-400 text-slate-900 font-black py-5 px-14 rounded-full text-2xl shadow-[0_0_30px_rgba(245,158,11,0.4)] transform active:scale-90 transition-all">
            é–‹å§‹æŒ‘æˆ°
        </button>
        
        <p class="text-[10px] text-slate-600 uppercase tracking-widest">Requires Motion Permissions on iOS</p>
    </div>

    <!-- 2. éŠæˆ²é€²è¡Œç•«é¢ -->
    <div id="game-screen" class="hidden-screen flex-grow flex flex-col items-center justify-center w-full space-y-10">
        <div class="flex flex-col items-center">
            <div id="timer" class="text-7xl font-black text-white tabular-nums">10</div>
            <div class="flex items-center mt-2 space-x-2 bg-black/40 px-3 py-1 rounded-full">
                <span id="sensor-indicator"></span>
                <span class="text-[10px] text-slate-400 uppercase font-bold tracking-widest">Sensor Active</span>
            </div>
        </div>
        
        <div class="relative w-full flex justify-center items-end" style="height: 45vh;">
            <!-- å™´ç™¼ç‰¹æ•ˆ -->
            <div id="foam" class="foam-spray"></div>
            
            <!-- å•¤é…’ç“¶ SVG -->
            <div id="bottle" class="bottle-container">
                <svg width="100" height="280" viewBox="0 0 100 280" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <!-- ç“¶èº« -->
                    <path d="M30,25 L70,25 L70,70 C70,70 90,100 90,140 L90,250 C90,265 80,280 65,280 L35,280 C20,280 10,265 10,250 L10,140 C10,100 30,70 30,70 Z" fill="#3b210b" />
                    <!-- é…’æ¨™ -->
                    <rect x="18" y="150" width="64" height="80" rx="4" fill="#f59e0b" />
                    <text x="50" y="195" font-family="Arial" font-size="14" fill="#3b210b" font-weight="900" text-anchor="middle">SUPER</text>
                    <text x="50" y="215" font-family="Arial" font-size="16" fill="#3b210b" font-weight="900" text-anchor="middle">BEER</text>
                    <!-- ç“¶è“‹ -->
                    <rect id="bottle-cap" x="28" y="10" width="44" height="15" rx="3" fill="#94a3b8" />
                </svg>
            </div>
        </div>

        <div class="w-full max-w-xs space-y-2">
            <div class="flex justify-between text-[10px] font-bold text-amber-500 uppercase tracking-widest">
                <span>Pressure</span>
                <span id="pressure-text">0%</span>
            </div>
            <div class="w-full bg-slate-800 h-4 rounded-full overflow-hidden border border-slate-700">
                <div id="pressure-bar" class="h-full bg-amber-500 w-0 transition-all duration-75 progress-glow"></div>
            </div>
        </div>
        
        <p class="text-white font-black text-xl italic animate-pulse">SHAKE IT!!!!!</p>
    </div>

    <!-- 3. çµæœç•«é¢ -->
    <div id="result-screen" class="hidden-screen flex flex-col items-center justify-center flex-grow space-y-8 text-center w-full">
        <div class="space-y-1">
            <h2 class="text-xl font-bold text-slate-500 uppercase tracking-widest">å™´ç™¼é«˜åº¦</h2>
            <div class="text-8xl font-black text-white"><span id="final-score">0</span><span class="text-3xl ml-2 text-amber-500">m</span></div>
        </div>
        
        <div id="best-record" class="bg-amber-500/10 px-8 py-3 rounded-2xl text-amber-500 border border-amber-500/20 font-bold">
            ä»Šæ—¥æœ€é«˜ç´€éŒ„: 0m
        </div>

        <div id="result-message" class="text-xl text-slate-300 font-medium px-6 leading-relaxed"></div>

        <button id="btn-restart" class="bg-white text-slate-950 font-black py-4 px-12 rounded-full text-xl shadow-xl active:scale-95 transition-all">
            å†æŒ‘æˆ°ä¸€æ¬¡
        </button>
    </div>

    <script>
        // éŠæˆ²æ ¸å¿ƒé‚è¼¯
        let state = 'START';
        let pressure = 0;
        let timeLeft = 10;
        let timerInterval;
        let bestScore = localStorage.getItem('beerBestScore') || 0;
        const MAX_PRESSURE = 1200; // å¢åŠ ä¸Šé™é›£åº¦

        // DOM å…ƒç´ é¸å–
        const screens = {
            start: document.getElementById('start-screen'),
            game: document.getElementById('game-screen'),
            result: document.getElementById('result-screen')
        };
        const bar = document.getElementById('pressure-bar');
        const timerTxt = document.getElementById('timer');
        const scoreTxt = document.getElementById('final-score');
        const indicator = document.getElementById('sensor-indicator');

        // åˆå§‹åŒ– HTTPS æª¢æŸ¥
        if (window.location.protocol !== 'https:' && !['localhost', '127.0.0.1'].includes(window.location.hostname)) {
            document.getElementById('https-msg').classList.remove('hidden-screen');
        }

        updateBestScoreUI();

        // å•Ÿå‹•æŒ‰éˆ• (è™•ç† iOS æ¬Šé™)
        document.getElementById('btn-start').addEventListener('click', async () => {
            if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
                try {
                    const result = await DeviceMotionEvent.requestPermission();
                    if (result === 'granted') {
                        startGame();
                    } else {
                        alert('éœ€è¦å‹•ä½œæ¬Šé™æ‰èƒ½é€²è¡ŒéŠæˆ²ï¼');
                    }
                } catch (e) {
                    startGame(); 
                }
            } else {
                startGame();
            }
        });

        document.getElementById('btn-restart').addEventListener('click', () => {
            resetGame();
            startGame();
        });

        function startGame() {
            state = 'PLAYING';
            pressure = 0;
            timeLeft = 10;
            
            screens.start.classList.add('hidden-screen');
            screens.result.classList.add('hidden-screen');
            screens.game.classList.remove('hidden-screen');
            
            timerTxt.innerText = timeLeft;
            document.getElementById('bottle').classList.add('shaking');
            
            window.addEventListener('devicemotion', handleMotion);
            
            timerInterval = setInterval(() => {
                timeLeft--;
                timerTxt.innerText = timeLeft;
                if (timeLeft <= 0) finishGame();
            }, 1000);
        }

        function handleMotion(event) {
            if (state !== 'PLAYING') return;

            // ç›¸å®¹æ€§è™•ç†ï¼šå˜—è©¦ç²å–åŠ é€Ÿåº¦
            const acc = event.acceleration || event.accelerationIncludingGravity;
            if (!acc) return;

            // æŒ‡ç¤ºç‡ˆé–ƒçˆ
            indicator.classList.add('sensor-ok');
            setTimeout(() => indicator.classList.remove('sensor-ok'), 50);

            const x = acc.x || 0;
            const y = acc.y || 0;
            const z = acc.z || 0;
            
            // è¨ˆç®—ä¸‰è»¸åˆåŠ›
            const force = Math.sqrt(x*x + y*y + z*z);
            
            // é–¥å€¼è¨­å®šï¼Œéæ¿¾å¾®å°ç§»å‹•
            if (force > 4) {
                // æ ¹æ“šæ˜¯å¦æœ‰é‡åŠ›æ•¸æ“šèª¿æ•´æ¬Šé‡
                const multiplier = event.acceleration ? 0.8 : 0.4;
                pressure += force * multiplier;
                if (pressure > MAX_PRESSURE) pressure = MAX_PRESSURE;
                updateGameUI();
            }
        }

        function updateGameUI() {
            const ratio = pressure / MAX_PRESSURE;
            bar.style.width = (ratio * 100) + '%';
            document.getElementById('pressure-text').innerText = Math.floor(ratio * 100) + '%';
            
            // éš¨å£“åŠ›å¢åŠ æ™ƒå‹•é€Ÿåº¦
            const speed = 0.1 - (ratio * 0.08);
            document.getElementById('bottle').style.animationDuration = Math.max(0.02, speed) + 's';
        }

        function finishGame() {
            state = 'ANIMATING';
            clearInterval(timerInterval);
            window.removeEventListener('devicemotion', handleMotion);
            document.getElementById('bottle').classList.remove('shaking');
            
            // åŸ·è¡Œå™´ç™¼å‹•ä½œ
            playPopAnimation();
        }

        function playPopAnimation() {
            const cap = document.getElementById('bottle-cap');
            const foam = document.getElementById('foam');
            const ratio = pressure / MAX_PRESSURE;
            
            // 1. ç“¶è“‹é£›å‡º
            cap.style.transition = 'transform 0.4s cubic-bezier(0.2, 0, 0.2, 1), opacity 0.3s';
            cap.style.transform = `translateY(-400px) rotate(${720 * ratio}deg) translateX(${50 * (Math.random()-0.5)}px)`;
            cap.style.opacity = '0';

            // 2. æ³¡æ²«å™´ç™¼
            const sprayHeight = ratio * 500; // è¦–è¦ºé«˜åº¦
            foam.style.height = sprayHeight + 'px';
            
            // 3. ç²’å­ç‰¹æ•ˆ
            createParticles(sprayHeight, ratio);

            // 4. è¨ˆç®—åˆ†æ•¸ä¸¦é¡¯ç¤º
            const score = Math.floor(ratio * 100); 
            setTimeout(() => showResults(score), 2500);
        }

        function createParticles(height, ratio) {
            const count = 40 + (ratio * 60);
            const container = document.getElementById('game-screen');
            for (let i = 0; i < count; i++) {
                const p = document.createElement('div');
                p.className = 'particle';
                const size = Math.random() * 10 + 4;
                p.style.width = size + 'px';
                p.style.height = size + 'px';
                p.style.left = '50%';
                p.style.bottom = (240 + height) + 'px';
                
                const tx = (Math.random() - 0.5) * 300;
                const ty = -Math.random() * 500;
                
                container.appendChild(p);
                p.animate([
                    { transform: 'translate(0, 0)', opacity: 1 },
                    { transform: `translate(${tx}px, ${ty}px)`, opacity: 0 }
                ], {
                    duration: 1000 + Math.random() * 1000,
                    easing: 'ease-out',
                    fill: 'forwards'
                });
                setTimeout(() => p.remove(), 2000);
            }
        }

        function showResults(score) {
            state = 'RESULT';
            screens.game.classList.add('hidden-screen');
            screens.result.classList.remove('hidden-screen');
            
            scoreTxt.innerText = score;
            
            // æ›´æ–°æœ€é«˜åˆ†
            if (score > bestScore) {
                bestScore = score;
                localStorage.setItem('beerBestScore', bestScore);
                document.getElementById('result-message').innerHTML = "ğŸ”¥ <strong>æ–°ç´€éŒ„ï¼</strong><br>ä½ çš„æ‰‹é€Ÿç°¡ç›´æ˜¯å–®èº«ä¸‰åå¹´çš„å¯¦åŠ›ï¼";
            } else {
                if (score > 80) document.getElementById('result-message').innerText = "å¤ªç‹‚äº†ï¼é€™ç“¶é…’å™´åˆ°äº†äºŒæ¨“ï¼";
                else if (score > 40) document.getElementById('result-message').innerText = "ä¸éŒ¯å–”ï¼Œéå¸¸æœ‰æ°£ï¼";
                else document.getElementById('result-message').innerText = "åŠ›é“ä¸å¤ å–”ï¼Œå†åŠ æŠŠå‹å§ï¼";
            }
            updateBestScoreUI();
        }

        function updateBestScoreUI() {
            document.getElementById('best-record').innerText = `ä»Šæ—¥æœ€é«˜ç´€éŒ„: ${bestScore}m`;
        }

        function resetGame() {
            pressure = 0;
            bar.style.width = '0%';
            const cap = document.getElementById('bottle-cap');
            cap.style.transition = 'none';
            cap.style.transform = 'none';
            cap.style.opacity = '1';
            document.getElementById('foam').style.height = '0';
            document.getElementById('pressure-text').innerText = '0%';
        }
    </script>
</body>
</html>